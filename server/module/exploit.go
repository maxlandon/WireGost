package module

import modulepb "github.com/maxlandon/wiregost/proto/v1/gen/go/module"

// Exploit - A module dedicated to exploitation activities. Like other module types, when an exploit
// module is executed by the user, a higher level function ExploitDriver() takes care of initiating
// and monitoring the full exploitation process, from setup to session registration and exit.
// Therefore, although many methods of the exploit.Module type will not be available because it
// hides behind a Module interface, they will still be executed behind the scenes.
type Exploit struct {
	// Base module. Allows us to us the module's logging system. The exploit driver
	// will decide, based on user choices, if the local debugging (happening in
	// most of these functions below) should be pushed back to the user console.
	*module

	// Includes a payload
	Payload *Payload

	// Includes some targets. Targets should be an object accepting various things
	// (URLs, IPs, ranges, etc.), and they would be processed by this Exploit, and
	// used by the ExploitDriver running the exploit.

	// Timeout and performance settings
}

// NewExploit - Instantiates an exploit module inheriting base functionality from the module.Module object.
func NewExploit() (m *Exploit) {
	return
}

// Init - Module initialization process: parses metadata/information, register options. It is called
// by the Stack binary, which then sends back module information as Protobuf to the server.
// Again, the function is called in the server, before the exploit is handled over to its driver.
func (m *Exploit) Init(meta *modulepb.Info) (err error) {

	// Checks various fields and adds some if needed. (Type-specific)
	meta.Type = modulepb.Type_EXPLOIT // Set module type

	// Parses the protobuf metadata (base module function)
	err = m.information(meta)

	return nil
}

// - Adds default options for things like Payload path, etc.
// - Check default targets
// - Process given string targets: we should have a detailed & modular function for this.

// Compatibility methods (check targets against payloads, output lists of them, etc.)

// Setup - Prepares the module for exploitation, initializes any needed state.
func (m *Exploit) Setup() (err error) {

	// Configure the associated payload handler

	// Start the handler if reverse, return if bind (we don't want to start it now)

	return
}

// GeneratePayload - This function instructs the Payload field to generate itself, according to its
// current settings (which could be set from the exploit module), and manages its resulting state.
func (m *Exploit) GeneratePayload() (err error) {
	return
}

// Cleanup - Clean any state needed for this module, such as connections and handlers.
func (m *Exploit) Cleanup() (err error) {

	return
}
